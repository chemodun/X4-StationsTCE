<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Stations_Trade_Config_Exchanger_Interface" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Main" version="2">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
        <set_value name="$DebugChance" exact="0" />
        <set_value name="$uixInteractMenuPresent" exact="false" />
        <set_value name="$isInitializedAt" exact="null" />
      </actions>
      <patch sinceversion="2">
        <set_value name="$uixInteractMenuPresent" exact="false" />
        <set_value name="$isInitializedAt" exact="null" />
      </patch>
      <cues>
        <cue name="STCE_On_Reload" instantiate="true" version="1">
          <conditions>
            <check_any>
              <event_cue_signalled cue="md.Interact_Menu_API.Reloaded" />
              <event_game_loaded />
            </check_any>
          </conditions>
          <actions>
            <do_if value="not $isInitializedAt? or (player.age - $isInitializedAt) gt 10">
              <set_value name="$uixInteractMenuPresent" exact="false" />
              <raise_lua_event name="'Interact_Menu_API.Existence_Query'" />
              <reset_cue cue="this" />
            </do_if>
          </actions>
        </cue>

        <cue name="STCE_On_UIX_Interact_Menu_Present" instantiate="true" version="1">
          <conditions>
            <event_ui_triggered screen="'UIX_Interact_Menu_Present'" />
          </conditions>
          <actions>
            <set_value name="$uixInteractMenuPresent" exact="true" />
            <debug_text text="'TradeConfigExchanger: UIX Interact Menu Present: %s'.[$uixInteractMenuPresent]" chance="100" filter="scripts" />
            <raise_lua_event name="'Interact_Menu_API.Add_Custom_Actions_Group_Id'" param="'station_trade_management_group'" />
            <raise_lua_event name="'Interact_Menu_API.Add_Custom_Actions_Group_Text'" param="{1972092405, 10001}" />
            <reset_cue cue="this" />
          </actions>
        </cue>

        <cue name="Add_Menu_Item" instantiate="true">
          <conditions>
            <event_cue_signalled cue="md.Interact_Menu_API.Get_Actions" />
          </conditions>
          <actions>
            <set_value name="$station" exact="event.param.$object" />
            <do_if
              value="$station.owner == faction.player and $station.isclass.{class.station} and $station.storagemodules.count gt 0 and not @$station.isshipyard and not @$station.iswharf">
              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id         = 'trade_config_exchanger_load',
                  $section    = if @$uixInteractMenuPresent == true then 'station_trade_management_group' else 'main',
                  $text       = {1972092405, 1},
                  $mouseover  = {1972092405, 2},
                  $text2      = if @$uixInteractMenuPresent == true then '' else $station.knownname,
                  $icon       = 'menu_shoppingcart',
                  $active     = true,
                  $callback   = Show_Interface,
                ]" />
            </do_if>
          </actions>
        </cue>

        <cue name="Show_Interface" instantiate="true">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <set_value name="$station" exact="event.param.$object" />
            <debug_text
              text="'TradeConfigExchanger: Show\n Station: %s.\n event.param: %s.'.[@$station.debugname, @event.param]" chance="100" filter="scripts" />
            <do_if
              value="$station.owner == faction.player and $station.isclass.{class.station} and $station.storagemodules.count gt 0 and not @$station.isshipyard and not @$station.iswharf">
              <do_if value="not player.entity.$TradeConfigExchangerSelectedStation?">
                <set_value name="player.entity.$TradeConfigExchangerSelectedStation" exact="[]" />
              </do_if>
              <set_value name="$args" exact="table[$selectedStation = $station]" />
              <append_to_list name="player.entity.$TradeConfigExchangerSelectedStation" exact="$args" />
              <debug_text
                text="'TradeConfigExchanger: Request invoked with args: %s'.[$args]"
                chance="100" filter="scripts" />
              <raise_lua_event name="'TradeConfigExchangerShow'" />
              <remove_value name="$args" />
            </do_if>
          </actions>
        </cue>

        <cue name="External_Call" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'TradeConfigExchanger'" control="'show'" />
          </conditions>
          <actions>
            <debug_text
              text="'TradeConfigExchanger: External_Call triggered with data: %s'.[@player.entity.$TradeConfigExchangerSelectedStation.last]" chance="100"
              filter="scripts" />
            <raise_lua_event name="'TradeConfigExchangerShow'" />
          </actions>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>